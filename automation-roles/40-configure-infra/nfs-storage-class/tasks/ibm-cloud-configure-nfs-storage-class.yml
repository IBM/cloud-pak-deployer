---
- name: Validate if Dynamic NFS Storage {{ nfs_storage_class_name }}  class exists
  shell: |
    oc get sc {{ nfs_storage_class_name }}
  failed_when: False
  register: oc_storage_class_exists

- name: Install NFS Storage class {{ nfs_storage_class_name }}
  block:
    - set_fact:
        _nfs_server: "{{ all_config.nfs_server | json_query(query) | first | default({}) }}"
      vars:
        query: >-
          [?name=='{{ current_openshift_storage.nfs_server_name }}']

    - name: Retrieve Terraform tfstate from the vault
      include_role: 
        name: vault-get-secret
      vars:
        secret_name: "{{ environment_name }}-terraform-tfstate"
        secret_group: "{{ environment_name }}"
        _p_secret_variable: tfstate

    - name: Show tfstate file
      debug:
        var: tfstate

    # Retrieve the private IP address of the NFS server
    - name: Retrieving IP address of NFS mount point {{ _nfs_server.name }}-mount
      set_fact:
        _nfs_server_ip: "{{ tfstate.resources | json_query(query) | first }}"
      vars:
        query: >-
          [?type=='ibm_is_share_mount_target' && instances[0].attributes.name=='{{ _nfs_server.name }}-mount'].instances[0].attributes.virtual_network_interface[0].primary_ip[0].address

    - name: Retrieving mount path of NFS mount point {{ _nfs_server.name }}-mount
      set_fact:
        _nfs_mount_path: "{{ tfstate.resources | json_query(query) | first }}"
      vars:
        query: >-
          [?type=='ibm_is_share_mount_target' && instances[0].attributes.name=='{{ _nfs_server.name }}-mount'].instances[0].attributes.mount_path

    - name: NFS Server IP address
      debug:
        msg: "{{ _nfs_server_ip }}"

    - name: NFS Server mount path
      debug:
        msg: "{{ _nfs_mount_path }}"

    - set_fact:
        _nfs_storage_class: "{{ nfs_storage_class_name }}"
        _nfs_storage_server_ip: "{{ _nfs_server_ip }}"
        _nfs_storage_server_path: "{{ _nfs_mount_path | regex_search('^(.+):(.+)', '\\2') | first }}"

    - name: Create {{ nfs_storage_class_name }} storage class
      include_tasks: create-nfs-storage-class.yml

  when: oc_storage_class_exists.rc != 0
