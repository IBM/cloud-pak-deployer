---
- name: Validate if Dynamic NFS Storage {{ nfs_storage_class_name }}  class exists
  shell: |
    oc get sc {{ nfs_storage_class_name }}
  failed_when: False
  register: oc_storage_class_exists

- name: Install NFS Storage class {{ nfs_storage_class_name }}
  block:
    - set_fact:
        _nfs_server: "{{ all_config.nfs_server | json_query(query) | first | default({}) }}"
      vars:
        query: >-
          [?name=='{{ current_openshift_storage.nfs_server_name }}']

    - set_fact:
        _nfs_storage_class: "{{ nfs_storage_class_name }}"
        _nfs_storage_server_ip: "{{ _nfs_server.infrastructure.host_ip }}"
        _nfs_storage_server_path: "{{ _nfs_server.infrastructure.storage_folder }}"
      when: cloud_platform == 'vsphere'

    - name: Create {{ nfs_storage_class_name }} storage class
      include_tasks: create-nfs-storage-class.yml

  when: oc_storage_class_exists.rc != 0
