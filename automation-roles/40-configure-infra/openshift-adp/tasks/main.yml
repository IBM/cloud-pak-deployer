---
- name: Validate mandatory variables for OpenShift Advanced Data Protection
  assert:
    that:
      - _p_openshift_cluster is defined

- block:
  - set_fact:
      _create_openshift_adp_ns: "oc create ns openshift-adp || true"
      _annotate_openshift_adp_ns: 'oc annotate namespace openshift-adp openshift.io/node-selector="" --overwrite'

  - include_role:
      name: log-deployer-activity
    vars:
      _p_activity_description: "Create project openshift-adp"
      _p_activity_commandl: "{{ _create_openshift_adp_ns }}"

  - name: Create project openshift-adp
    shell: |
      {{ _create_openshift_adp_ns }}
    when: not cpd_dry_run

  - include_role:
      name: log-deployer-activity
    vars:
      _p_activity_description: "Annotate project openshift-adp namespace"
      _p_activity_commandl: "{{ _annotate_openshift_adp_ns }}"

  - name: Annotate project openshift-adp namespace
    shell: |
      {{ _annotate_openshift_adp_ns }}
    when: not cpd_dry_run

  - name: Retrieve default channel for redhad-oadp-operator manifest
    shell:
      oc get packagemanifest redhat-oadp-operator -o jsonpath='{.status.defaultChannel}'
    register: _oadp_packagemanifest

  - set_fact:
      _oadp_channel: "{{ _oadp_packagemanifest.stdout }}"

  - include_role:
      name: generate-apply-yaml
    vars:
      _p_apply_yaml_description: Create OpenShift Advanced Data Protection operator
      _p_apply_yaml_template: openshift-adp-sub.j2
      _p_apply_yaml_output_file: "{{ status_dir }}/openshift/openshift-adp-sub.yaml"

  when: (_p_openshift_cluster.oadp | default(False) | bool)