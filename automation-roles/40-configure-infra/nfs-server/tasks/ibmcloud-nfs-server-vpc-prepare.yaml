---

- set_fact:
    bastion_host: "{{ current_nfs_server['infrastructure']['bastion_host'] }}"
    nfs_server_ssh_key: "{{ current_nfs_server['infrastructure']['keys'][0] }}"

- name: Retrieve Terraform tfstate from the vault
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ environment_name }}-terraform-tfstate"
    secret_group: "{{ environment_name }}"
    _p_secret_variable: tfstate

- name: Show tfstate file
  debug:
    var: tfstate

# Retrieve the private IP address of the NFS server
- name: Retrieving IP address of NFS mount point {{ current_nfs_server.name }}-mount
  set_fact:
    _nfs_server_ip: "{{ tfstate.resources | json_query(query) | first }}"
  vars:
    query: >-
      [?type=='ibm_is_share_mount_target' && instances[0].attributes.name=='{{ current_nfs_server.name }}-mount'].instances[0].attributes.virtual_network_interface[0].primary_ip[0].address

- name: Retrieving mount path of NFS mount point {{ current_nfs_server.name }}-mount
  set_fact:
    _nfs_mount_path: "{{ tfstate.resources | json_query(query) | first }}"
  vars:
    query: >-
      [?type=='ibm_is_share_mount_target' && instances[0].attributes.name=='{{ current_nfs_server.name }}-mount'].instances[0].attributes.mount_path

- name: NFS Server IP address
  debug:
    msg: "{{ _nfs_server_ip }}"

- name: NFS Server mount path
  debug:
    msg: "{{ _nfs_mount_path }}"