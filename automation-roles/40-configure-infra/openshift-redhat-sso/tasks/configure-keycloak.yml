---
- include_role:
    name: generate-apply-yaml
  vars:
    _p_apply_yaml_description: Create Keycloak
    _p_apply_yaml_template: redhat-sso-keycloak.j2
    _p_apply_yaml_output_file: "{{ status_dir }}/openshift/{{ current_openshift_cluster.name }}-{{ _keycloak_name }}-keycloak.yaml"

- block:
  - name: Wait until Keycloak {{ _keycloak_name }} is ready
    kubernetes.core.k8s_info:
      api_version: keycloak.org/v1alpha1
      kind: keycloaks
      name: "{{ _keycloak_name }}"
      namespace: "{{ _keycloak_name }}"
    register: _keycloak
    until: 
    - _keycloak.resources | default([]) | length > 0
    - (_keycloak.resources[0].status.ready | default('') | lower) == 'true'
    retries: 30
    delay: 30

  - name: Get Keycloak information
    include_role:
      name: get-keycloak-info
    vars:
      _p_keycloak_name: "{{ _keycloak_name }}"

  - name: Create Keycloak groups
    include_tasks: create-keycloak-group.yml
    loop: "{{ _current_openshift_redhat_sso.groups | default([]) }}"
    loop_control:
      loop_var: _current_keycloak_group

  - name: Create Keycloak users
    include_tasks: create-keycloak-user.yml
    loop: "{{ _current_openshift_redhat_sso.users | default([]) }}"
    loop_control:
      loop_var: _current_keycloak_user

  when: not cpd_dry_run