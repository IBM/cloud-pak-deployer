---
- set_fact:
    _current_openldap: {}

- when: "all_config.openldap is defined"
  block:
  - set_fact:
      _current_openldap: "{{ all_config.openldap | json_query(query) | first | default({}) }}"
    vars:
      query: >-
        [?openshift_cluster_name=='{{ current_openshift_cluster.name }}']
  - name: Show openldap for current cluster
    debug:
      var: _current_openldap

- ansible.builtin.include_tasks: install-openldap.yml
  when: 
  - _current_openldap != {}
  - _current_openldap.state | default('installed') == 'installed'

- ansible.builtin.include_tasks: remove-openldap.yml
  when: _current_openldap == {} or _current_openldap.state | default('installed') != 'installed'