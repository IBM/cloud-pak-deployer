---
- set_fact:
    _cp_alt_repo: "{{ all_config.cp_alt_repo }}"

- name: Get CASE repository token from vault secret {{ _cp_alt_repo.case_repo_token_secret }}
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ _cp_alt_repo.case_repo_token_secret }}"
    secret_group: "{{ environment_name }}"
    _p_secret_variable: _case_repo_token

- name: Get alternative registry credentials vault secret {{ _cp_alt_repo.registry_secret }}
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ _cp_alt_repo.registry_secret }}"
    secret_group: "{{ environment_name }}"
    _p_secret_variable: _alt_registry_secret

- name: Strip off https from the repository URLs
  set_fact:
    _case_repo_path_cp: "{{ (_cp_alt_repo.case_repo_path_cp | urlsplit('hostname')) + (_cp_alt_repo.case_repo_path_cp | urlsplit('path')) }}"
    _case_repo_path_fs: "{{ (_cp_alt_repo.case_repo_path_fs | urlsplit('hostname')) + (_cp_alt_repo.case_repo_path_fs | urlsplit('path')) }}"
    _case_repo_path_opencontent: "{{ (_cp_alt_repo.case_repo_path_opencontent | urlsplit('hostname')) + (_cp_alt_repo.case_repo_path_opencontent | urlsplit('path')) }}"

- name: Extract registry user and password
  set_fact:
    _alt_registry_user: "{{ _alt_registry_secret | regex_search('^(.+):(.+)', '\\1') | first }}"
    _alt_registry_password: "{{ _alt_registry_secret | regex_search('^(.+):(.+)', '\\2') | first }}"

- name: Generate play_env.sh
  template:
    src: play_env.j2
    dest: "{{ status_dir }}/cloud-pak/play_env.sh"

- name: Generate resolvers.yaml
  template:
    src: resolvers.j2
    dest: "{{ status_dir }}/cloud-pak/resolvers.yaml"

- name: Generate resolvers_auth.yaml
  template:
    src: resolvers_auth.j2
    dest: "{{ status_dir }}/cloud-pak/resolvers_auth.yaml"

- name: Copy casectl files to /tmp/work
  copy:
    src: "{{ item }}"
    dest: /tmp/work/
    remote_src: true
  loop:
    - "{{ status_dir }}/cloud-pak/play_env.sh"
    - "{{ status_dir }}/cloud-pak/resolvers.yaml"
    - "{{ status_dir }}/cloud-pak/resolvers_auth.yaml"
