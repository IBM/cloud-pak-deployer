---
- block:
  - name: Check if Red Hat Certificate Manager is already installed
    kubernetes.core.k8s_info:
      api_version: operators.coreos.com/v1alpha1
      kind: ClusterServiceVersion
      label_selectors:
      - operators.coreos.com/openshift-cert-manager-operator.cert-manager-operator
    register: _get_red_hat_cert_manager
  - name: Check if IBM Certificate Manager is installed
    kubernetes.core.k8s_info:
      api_version: operators.coreos.com/v1alpha1
      kind: ClusterServiceVersion
      namespace: ibm-cert-manager
      label_selectors:
      - operators.coreos.com/ibm-cert-manager-operator.ibm-cert-manager
    register: _get_ibm_cert_manager

  - debug:
      var: _get_cert_managers
    vars:
      _get_cert_managers:
        _get_ibm_cert_manager: "{{ _get_ibm_cert_manager }}"
        _get_red_hat_cert_manager: "{{ _get_red_hat_cert_manager }}"
        _rh_cert_manager_version: "{{ _get_red_hat_cert_manager.resources[0].spec.version | default('') }}"

  - fail:
      msg: >-
        If watsonx Orchestrate 5.0 or 5.1 is installed, Red Hat Certificate Manager 1.14 or the IBM Certificate Manager is mandatory. 
        Red Hat Certificate Manager {{ _get_red_hat_cert_manager.resources[0].spec.version | default('') }} was found. 
        Please delete the Red Hat Certificate Manager namespaces cert-manager and cert-manager-operator and set 
        cp4d.ibm_cert_manager to True. Then re-run deployer.
    when: 
    - _get_ibm_cert_manager.resources == []
    - not (_get_red_hat_cert_manager.resources[0].spec.version | default('')).startswith('1.14')
    - _p_cp4d_version < "5.2.0"
  when: 
  - not cpd_dry_run

- include_tasks: cp4d-prep-wxo-app-connect.yml
  when: _p_cp4d_version < "5.1.3"

- include_tasks: cp4d-setup-mcg-secrets.yml
  vars:
    _p_component: watson_assistant

- include_tasks: cp4d-setup-mcg-secrets.yml
  vars:
    _p_component: watsonx_orchestrate

- block:
  - set_fact:
      _cp4d_admin_password_vault_key_name: "cp4d_admin_{{ _p_current_cp4d_cluster.project| replace('-','_') }}_{{ _p_current_cp4d_cluster.openshift_cluster_name| replace('-','_') }}"

  - name: Retrieve CP4D admin password from vault secret {{ _cp4d_admin_password_vault_key_name }}
    include_role: 
      name: vault-get-secret
    vars:
      secret_name: "{{ _cp4d_admin_password_vault_key_name }}"
      secret_group: "{{ environment_name }}"
      _p_secret_variable: _cp4d_admin_password_vault

  - name: Generate command to setup watsonx Assistant instances for watsonx Orchestrate releases < 5.0.0
    set_fact:
      _setup_watsonx_assistant_instances: "{{ lookup('template', 'setup-watsonx-assistant-instances.j2') }}"

  - include_role:
      name: log-deployer-activity
    vars:
      _p_activity_description: "Setup watsonx Assistant instances for watsonx Orchestrate releases < 5.0.0"
      _p_activity_command: "{{ _setup_watsonx_assistant_instances }}"

  - name: Setup watsonx Assistant instances for watsonx Orchestrate for releases < 5.0.0
    shell: |
      setup-wxo-assistant \
        --cpd_instance_ns={{ _p_current_cp4d_cluster.project }} \
        --create_assistants=true \
        --user={{ _cp4d_user }} \
        --password={{ _cp4d_admin_password_vault }} \
        --auth_type=password
    register: _setup_wxo_assistant
    retries: 5
    delay: 10
    until: _setup_wxo_assistant.rc == 0
    when: not cpd_dry_run
  when: _p_cp4d_version < "5.0.0"

<<<<<<< HEAD
- name: Set installation options for watsonx Orchestrate
  include_tasks: cp4d-installation-options.yml
  vars:
    _cartridge_name: watsonx_orchestrate
    _root_options: True

=======
>>>>>>> main
- include_role:
    name: generate-apply-yaml
  vars:
    _p_apply_yaml_description: Create OperandRequest when doing watsonx Orchestrate lite installation
    _p_apply_yaml_template: wxo-lite-operand-request.j2
    _p_apply_yaml_output_file: "{{ status_dir }}/openshift/{{ _p_current_cp4d_cluster.project }}-wxo-lite-operand-request.yaml"
  when: (_current_cp4d_cartridge.installation_options.watson_orchestrate_install_mode | default('')) == 'lite'

- block:
  - name: Starting background task to patch OpsManager and RabbitMQCluster. Logs are in {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-wxo-48-patch.log
    shell: |
      {{ role_path }}/files/temp-patch-wxo.sh \
        {{ status_dir }} \
        {{ _p_current_cp4d_cluster.project }}
    async: 86400
    poll: 0
    register: _patch_wxo_48

  - name: Show details of background task to patch watsonx Orchestrate
    debug:
      var: _patch_wxo_48
  when: 
  - _p_cp4d_version == "4.8.4"
  - not cpd_dry_run