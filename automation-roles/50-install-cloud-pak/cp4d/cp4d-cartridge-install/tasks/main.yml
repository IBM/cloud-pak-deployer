---
- include_role:
    name: cp4d-variables

# Set fact which is handled when testing install of all cartridges
- set_fact:
    _cp4d_cartridges_installed_successfully: True

- include_tasks: cp4d-create-subscriptions-olm-utils.yml
  when: _p_cp4d_version < '5.3.0'

<<<<<<< HEAD
- name: Populate {{ status_dir }}/cp4d/{{ _p_current_cp4d_cluster.project }}-install-options.yml
  lineinfile:
    path: "{{ status_dir }}/cp4d/{{ _p_current_cp4d_cluster.project }}-install-options.yml"
    line: "custom_spec:"
    insertbefore: "BOF"
    state: present
    create: True
=======
- name: Set installation options for cartridges that will be installed
  include_tasks: cp4d-installation-options.yml
  loop: "{{ _cartridges_to_install | default([]) }}"
  loop_control:
    loop_var: _current_cp4d_cartridge
>>>>>>> main

- block:
  - name: Starting background task to patch Db2U clusters. Logs are in {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-db2u-temp-patch.log
    shell: |
      {{ role_path }}/files/temp-patch-db2u.sh \
        {{ status_dir }} \
        {{ _p_current_cp4d_cluster.project }}
    async: 86400
    poll: 0
    register: _patch_db2u

  - name: Show details of background task to patch Db2U
    debug:
      var: _patch_db2u
  when: not cpd_dry_run
<<<<<<< HEAD

- include_tasks: cp4d-install-cartridges-olm-utils.yml
=======

- name: Run pre-processing scripts
  include_tasks: cp4d-install-cr-pre-processing.yml
  loop: "{{ _cartridges_to_install | default([]) }}"
  loop_control:
    loop_var: _current_cp4d_cartridge

- include_tasks: cp4d-install-cartridges-olm-utils.yml
  vars:
    _p_apply_cartridges: "{{ _apply_cr_cartridges }}"
>>>>>>> main
  when: 
  - _apply_cr_cartridges_list != ''
  - _p_cp4d_version < '5.3.0'

<<<<<<< HEAD
- include_tasks: cp4d-install-cartridges.yml
=======
- include_tasks: cp4d-install-cartridges-install-components.yml
  vars:
    _p_apply_cartridges: "{{ _apply_cr_cartridges }}"
>>>>>>> main
  when: 
  - _apply_cr_cartridges_list != ''
  - _p_cp4d_version >= '5.3.0'

- name: Install separate cartridges
  include_tasks: cp4d-install-separate-cr.yml
  loop: "{{ _apply_cr_cartridges_separate | default([]) }}"
  loop_control:
    loop_var: _current_cp4d_cartridge

- include_tasks: cp4d-install-patch-520.yml
  when: 
<<<<<<< HEAD
  - current_cp4d_cluster.state=='installed'
  - _p_cp4d_version == '5.2.0'
  - current_cp4d_cluster.install_day0_patch | default(True) | bool
=======
  - _p_current_cp4d_cluster.state=='installed'
  - _p_cp4d_version == '5.2.0'
  - _p_current_cp4d_cluster.install_day0_patch | default(True) | bool
>>>>>>> main

- name: Run post-processing scripts
  include_tasks: cp4d-install-cr-post-processing.yml
  loop: "{{ _cartridges_to_install | default([]) }}"
  loop_control:
    loop_var: _current_cp4d_cartridge
  when:
  - not cpd_dry_run
  - (_install_cartridges_result.rc | default(0)) == 0