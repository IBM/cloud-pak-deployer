---
- name: Generate OLM utils command to create watsonx Orchestrate subscription
  set_fact:
    _apply_olm_wxo_command: "{{ lookup('template', 'apply-olm-cartridge-wxo.j2') }}" 

- name: Show apply-olm command to create watsonx Orchestrate subscription
  debug:
    var: _apply_olm_wxo_command

- name: Run apply-olm command to install watsonx Orchestrate subscriptions, logs are in {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-apply-olm-wxo.log
  shell: |
    {{ _apply_olm_wxo_command }} > {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-apply-olm-wxo.log 2>&1
  retries: 2
  delay: 10
  until: _apply_olm_wxo_result.rc==0
  register: _apply_olm_wxo_result

- set_fact:
    _cp4d_admin_password_vault_key_name: "cp4d_admin_{{ _p_current_cp4d_cluster.project| replace('-','_') }}_{{ _p_current_cp4d_cluster.openshift_cluster_name| replace('-','_') }}"

- name: Retrieve CP4D admin password from vault secret {{ _cp4d_admin_password_vault_key_name }}
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ _cp4d_admin_password_vault_key_name }}"
    secret_group: "{{ environment_name }}"
    _p_secret_variable: _cp4d_admin_password_vault

- name: Setup watsonx Assistant instances for watsonx watsonx.orchestrate for releases < 5.0.0
  shell: |
    setup-wxo-assistant \
      --cpd_instance_ns={{ _p_current_cp4d_cluster.project }} \
      --create_assistants=true \
      --user={{ _cp4d_user }} \
      --password={{ _cp4d_admin_password_vault }} \
      --auth_type=password
  register: _setup_wxo_assistant
  retries: 5
  delay: 10
  until: _setup_wxo_assistant.rc == 0

- block:
  - name: Starting background task to patch OpsManager and RabbitMQCluster. Logs are in {{ status_dir }}/log/{{ _p_current_cp4d_cluster.project }}-wxo-48-patch.log
    shell: |
      {{ role_path }}/files/temp-patch-wxo.sh \
        {{ status_dir }} \
        {{ _p_current_cp4d_cluster.project }}
    async: 86400
    poll: 0
    register: _patch_wxo_48

  - name: Show details of background task to patch watsonx Orchestrate
    debug:
      var: _patch_wxo_48
  when: _p_current_cp4d_cluster.cp4d_version == "4.8.4"