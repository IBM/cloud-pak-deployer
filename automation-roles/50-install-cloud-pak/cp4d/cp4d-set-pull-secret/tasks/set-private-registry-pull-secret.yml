---
- name: Connect to private image registry
  include_role: 
    name: connect-private-image-registry

- name: Get pull secret for image registry {{ _p_current_cp4d_cluster.image_registry_name }} from the vault
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "image-registry-{{ _p_current_cp4d_cluster.image_registry_name }}"
    secret_group: "{{ environment_name }}"
    _p_secret_variable: _private_registry_pull_secret

- name: Validate if container registry credentials secret is available
  fail: msg="Container registry credentials secret image-registry-{{ _p_current_cp4d_cluster.image_registry_name }} from group {{ environment_name }} is empty"
  when: _private_registry_pull_secret== ""

- name: Set the global pull secret for the private registry
  include_role:
    name: cp-ocp-global-pull-secret
  vars:
    _p_registry_url: "{{ private_registry_url }}" 
    _p_registry_pull_secret: "{{ _private_registry_pull_secret }}"
  when: (_p_pull_secret_namespace | default('')) == ''

- name: Set ibm-entitlement-key pull secret in namespace {{ _p_pull_secret_namespace }} for private registry {{ private_registry_url }}
  ansible.builtin.include_role:
    name: cp4d-set-namespace-pull-secret
  vars:
    _p_namespace: "{{ _p_pull_secret_namespace }}"
    _p_registry: "{{ private_registry_url }}"
    _p_secret_value: "{{ _private_registry_pull_secret }}"
  when: (_p_pull_secret_namespace | default('')) != ''