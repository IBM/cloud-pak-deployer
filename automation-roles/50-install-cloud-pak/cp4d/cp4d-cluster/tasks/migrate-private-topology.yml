---
- name: Generate script to detach CP4D instance {{ current_cp4d_cluster.project }}-detach-instance.sh
  template:
    src: detach-cpd-instance.j2
    dest: "{{ status_dir}}/cp4d/{{ current_cp4d_cluster.project }}-detach-cpd-instance.sh"
    mode: u+rwx

- name: Detach Cloud Pak for Data instance from {{ foundational_services_project }}. Logs are in {{ status_dir }}/log/{{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-detach.log
  shell: |
    {{ status_dir}}/cp4d/{{ current_cp4d_cluster.project }}-detach-cpd-instance.sh > {{ status_dir }}/log/{{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-detach.log 2>&1

- name: Upgrade certificate manager and license service on cluster
  include_role:
    name: cp-fs-cluster-components
  vars:
    _p_cp4d_version: "{{ current_cp4d_cluster.cp4d_version }}"
    _p_migrate_topology: True

- name: Check if scheduler has been installed
  shell: |
    oc get scheduling -A --no-headers 2>&1
  failed_when: False
  register: _get_scheduling

# Only migrate scheduler if installed and not already migrated to Scheduler project
- block:
  - name: Generate script to migrate scheduler {{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-migrate-scheduler.sh
    template:
      src: migrate-scheduler.j2
      dest: "{{ status_dir}}/cp4d/{{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-migrate-scheduler.sh"
      mode: u+rwx

  - name: Migrate scheduler from {{ foundational_services_project }}. Logs are in {{ status_dir }}/log/{{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-migrate-scheduler.log
    shell: |
      {{ status_dir}}/cp4d/{{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-migrate-scheduler.sh > {{ status_dir }}/log/{{ current_cp4d_cluster.project }}-{{ foundational_services_project }}-migrate-scheduler.log 2>&1
  when: 
  - _get_scheduling.rc == 0
  - _get_scheduling.stdout is not search('.*ibm-scheduling.*')
