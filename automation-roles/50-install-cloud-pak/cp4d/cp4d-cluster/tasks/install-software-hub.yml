---
- set_fact:
    _cpd_platform_installation_options:
      installation_options:
        cloudpakfordata: true
        iamIntegration: "{{ current_cp4d_cluster.use_fs_iam | default(False) | bool }}"

- include_role:
    name: cp4d-installation-options
  vars:
    _p_cp4d_project: "{{ current_cp4d_cluster.project }}"
    _p_current_cp4d_cartridge: {}
    _p_cartridge_name: 'cpd_platform'
    _p_section: 'custom_spec'
    _p_installation_options: "{{ _cpd_platform_installation_options }}"

- block:
  - name: Generate setup-instance command for project {{ current_cp4d_cluster.project }} to install Software Hub
    set_fact:
      _setup_instance_command: "{{ lookup('template','setup-instance.j2') }}"

  - include_role:
      name: run-command
    vars:
      _p_command_description: Install Software Hub into project {{ current_cp4d_cluster.project }}
      _p_command: "{{ _setup_instance_command }}"
      _p_command_log_file: "{{ status_dir }}/log/{{ current_cp4d_cluster.project }}-install-software-hub.log"
      _p_command_environment:
        OLM_UTILS_IMAGE: "{{ _olm_utils_image_full }}"
      _p_cpd_cli_manage: True
  when: _install_control_plane