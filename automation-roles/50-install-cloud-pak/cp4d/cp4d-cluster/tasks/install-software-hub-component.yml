---
- name: Create cluster-scoped resources
  kubernetes.core.k8s:
    src: "{{ status_dir }}/work/cluster_scoped_resources.yaml"
    state: present
    
- name: Delete installation options file
  file:
    path: "{{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-install-options.yml"
    state: absent

- name: Populate {{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-install-options.yml
  lineinfile:
    path: "{{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-install-options.yml"
    line: "custom_spec:"
    insertbefore: "BOF"
    state: present
    create: True

- name: Insert Software Hub options into {{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-install-options.yml
  blockinfile:
    path: "{{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-install-options.yml"
    marker: "# {mark} CPD Platform options #"
    block: |2
        cpd_platform:
          cloudpakfordata: true
          iamIntegration: {{ current_cp4d_cluster.use_fs_iam | default(False) | bool }}

- include_role:
    name: log-deployer-activity
  vars:
    _p_activity_description: "Installation options file for install-components command"
    _p_activity_yaml: "{{ status_dir }}/cp4d/{{ current_cp4d_cluster.project }}-install-options.yml"

- block:
  - name: Generate install-components command for project {{ current_cp4d_cluster.project }} to install Software Hub
    set_fact:
      _install_components: "{{ lookup('template','install-components.j2') }}"

  - include_role:
      name: run-command
    vars:
      _p_command_description: Install Software Hub into project {{ current_cp4d_cluster.project }}
      _p_command: "{{ _install_components }}"
      _p_command_log_file: "{{ status_dir }}/log/{{ current_cp4d_cluster.project }}-install-software-hub.log"
      _p_command_environment:
        OLM_UTILS_IMAGE: "{{ _olm_utils_image_full }}"  
  when: _install_control_plane