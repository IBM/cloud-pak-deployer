---
- name: Show CP4D role definition
  debug:
    var: _cp4d_role

- name: Get existing CP4D roles
  uri:
    url: 'https://{{ _current_cp4d_url.stdout }}/usermgmt/v1/roles'
    method: GET
    headers:
      Authorization: "Bearer {{ _cp4d_bearer_token }}"
      Content-Type: "application/json"
    return_content: yes
    validate_certs: no
    status_code: 200
  register: _existing_cp4d_roles

- name: Show existing CP4D roles
  debug:
    var: _existing_cp4d_roles

- include_tasks: cp4d-check-permissions.yml
  when: _cp4d_role.state | default('installed') != 'removed'

- name: Show existing CP4D roles
  debug:
    var: _existing_cp4d_roles

- set_fact:
    _existing_cp4d_role: "{{ _existing_cp4d_roles.json.rows | json_query(query) | first | default({}) }}"
  vars:
    query: >-
      [?doc.role_name=='{{ _cp4d_role.name }}']

- include_tasks: cp4d-role-create.yml
  when: 
  - _cp4d_role.state | default('installed') == 'installed'
  - _existing_cp4d_role == {}

- include_tasks: cp4d-role-update.yml
  when: 
  - _cp4d_role.state | default('installed') == 'installed'
  - _existing_cp4d_role != {}

- include_tasks: cp4d-role-delete.yml
  when: 
  - _cp4d_role.state | default('installed') == 'removed'
  - _existing_cp4d_role != {}
