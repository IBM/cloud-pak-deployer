---
- debug:
    var: _cp4d_user_group

- name: Get existing CP4D user groups
  uri:
    url: 'https://{{ _current_cp4d_url.stdout }}/usermgmt/v2/groups'
    method: GET
    headers:
      Authorization: "Bearer {{ _cp4d_bearer_token }}"
      Content-Type: "application/json"
    return_content: yes
    validate_certs: no
    status_code: 200
  register: _existing_cp4d_user_groups

- name: Show existing CP4D user groups
  debug:
    var: _existing_cp4d_user_groups

- set_fact:
    _existing_cp4d_user_group: "{{ _existing_cp4d_user_groups.json.results | json_query(query) | first | default({}) }}"
  vars:
    query: >-
      [?name=='{{ _cp4d_user_group.name }}']

- include_tasks: cp4d-user-group-create.yml
  when: _existing_cp4d_user_group == {}

- include_tasks: cp4d-user-group-update.yml
  when: _existing_cp4d_user_group != {}