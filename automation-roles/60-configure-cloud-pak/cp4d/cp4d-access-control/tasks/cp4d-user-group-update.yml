---
- debug:
    var: _cp4d_user_group

- name: Get roles for existing user group {{ _existing_cp4d_user_group.name }}
  set_fact:
    _existing_cp4d_user_group_roles: "{{ _existing_cp4d_user_group.roles | map(attribute='role_name') | default([]) }}"

- name: Get roles for defined user group {{ _cp4d_user_group.name }}
  set_fact:
    _cp4d_user_group_roles: "{{ _cp4d_user_group.roles | default([]) }}"

- name: Get roles to be added
  set_fact:
    _cp4d_add_roles: "{{ _cp4d_user_group_roles | difference(_existing_cp4d_user_group_roles) | default([]) }}"

- name: Get role IDs for the roles to be added
  include_tasks: cp4d-get-role-identifiers.yml
  vars:
    _cp4d_user_group_roles: "{{ _cp4d_add_roles }}"

- set_fact:
    _cp4d_add_role_ids_list: "{{ _cp4d_user_group_role_ids_list }}"

- debug:
    var: _cp4d_add_role_ids_list

- name: Get roles to be removed
  set_fact:
    _cp4d_remove_roles: "{{ _existing_cp4d_user_group_roles | difference(_cp4d_user_group_roles) | default([]) }}"

- name: Get role IDs for the roles to be removed
  include_tasks: cp4d-get-role-identifiers.yml
  vars:
    _cp4d_user_group_roles: "{{ _cp4d_remove_roles }}"

- set_fact:
    _cp4d_remove_role_ids_list: "{{ _cp4d_user_group_role_ids_list }}"

- debug:
    var: _cp4d_remove_role_ids_list

- name: Update Cloud Pak for Data user group {{ _cp4d_user_group.name }} with new roles
  uri:
    url: "https://{{ _current_cp4d_url.stdout }}/usermgmt/v2/groups/{{ _existing_cp4d_user_group.group_id }}"
    method: PATCH
    headers:
      Authorization: "Bearer {{ _cp4d_bearer_token }}"
      Content-Type: "application/json"
    body_format: json
    body:
      description: "{{ _cp4d_user_group.description | default(_cp4d_user_group.name) }}"
      add_role_identifiers: "{{ _cp4d_add_role_ids_list }}"
      remove_role_identifiers: "{{ _cp4d_remove_role_ids_list }}"
    return_content: yes
    validate_certs: no
    status_code: 200
  register: _cp4d_user_group_update

- debug:
    var: _cp4d_user_group_update
