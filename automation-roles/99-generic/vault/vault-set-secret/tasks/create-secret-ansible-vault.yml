---
- name: Create secret Validate mandatory variables are defined
  assert:
    that:
      - secret_group is defined
      - secret_name is defined
      - file_secret_payload is defined
      - vault_password_file is defined

- name: Fail if a secret field was specified for a vault other than Hashicorp
  fail:
    msg: "Secret name {{ secret_name }} can only have a secret field specification for Hashicorp Vault"
  when: secret_name is search(",")

- name: Create directory {{ status_dir }}/vault if not existent
  file:
    path: "{{ status_dir }}/vault"
    state: directory

- name: Check if Ansible Vault file exists
  stat:
    path: "{{ status_dir }}/vault/{{ secret_group }}"
  register: ansible_vault_file_stat

- name: Handle Ansible Vault file creation or update
  block:
    - name: Create temporary file for plaintext content
      tempfile:
        state: file
        suffix: .plaintext
      register: temp_plaintext_file

    - name: Decrypt existing Ansible Vault file if it exists
      command: >
        ansible-vault decrypt
        --vault-password-file {{ vault_password_file }}
        --output {{ temp_plaintext_file.path }}
        {{ status_dir }}/vault/{{ secret_group }}
      when: ansible_vault_file_stat.stat.exists
      changed_when: false

    - name: Add or replace secret in plaintext file
      lineinfile:
        path: "{{ temp_plaintext_file.path }}"
        regexp: "^{{ secret_name }}="
        line: "{{ secret_name }}={{ file_secret_payload }}"
        state: present
        create: True

    - name: Encrypt plaintext file to Ansible Vault
      command: >
        ansible-vault encrypt
        --vault-password-file {{ vault_password_file }}
        --output {{ status_dir }}/vault/{{ secret_group }}
        {{ temp_plaintext_file.path }}
      changed_when: true

  always:
    - name: Remove temporary plaintext file
      file:
        path: "{{ temp_plaintext_file.path }}"
        state: absent
      when: temp_plaintext_file.path is defined

- name: Successfully created secret
  debug:
    msg: "Secret {{ secret_name }} successfully created in Ansible Vault file {{ secret_group }}"

