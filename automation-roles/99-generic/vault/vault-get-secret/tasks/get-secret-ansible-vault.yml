---
- name: Get secret Validate mandatory variables are defined
  assert:
    that:
      - secret_group is defined
      - secret_name is defined
      - vault_password_file is defined

- name: Fail if a secret field was specified for a vault other than Hashicorp
  fail:
    msg: "Secret name {{ secret_name }} can only have a secret field specification for Hashicorp Vault"
  when: secret_name is search(",")

- name: Check that ansible vault file {{ secret_group }} exists
  stat:
    path: "{{ status_dir }}/vault/{{ secret_group }}"
  register: ansible_vault_file_details

- set_fact:
    secret_value: ""

- name: Decrypt and retrieve secret from Ansible Vault file
  block:
    - name: Create temporary file for decrypted content
      tempfile:
        state: file
        suffix: .decrypted
      register: temp_decrypted_file

    - name: Decrypt Ansible Vault file
      command: >
        ansible-vault decrypt
        --vault-password-file {{ vault_password_file }}
        --output {{ temp_decrypted_file.path }}
        {{ status_dir }}/vault/{{ secret_group }}
      register: decrypt_result
      changed_when: false

    - name: Extract secret value from decrypted file
      shell: >
        grep -E "^{{ secret_name }}=" {{ temp_decrypted_file.path }} | cut -d "=" -f 2-
      register: secret_value_result
      changed_when: false

    - set_fact:
        secret_value: "{{ secret_value_result.stdout | b64decode }}"
      when: secret_value_result.stdout != ""

  always:
    - name: Remove temporary decrypted file
      file:
        path: "{{ temp_decrypted_file.path }}"
        state: absent
      when: temp_decrypted_file.path is defined

  when: ansible_vault_file_details.stat.exists

- include_tasks: write-secret-to-file.yml
  when: secret_file | default("") != ''

