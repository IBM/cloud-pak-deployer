---
- set_fact:
    _current_openshift_cluster: "{{ all_config.openshift | json_query(query) | first | default({}) }}"
  vars:
    query: >-
      [?name=='{{ _current_cp4d_cluster.openshift_cluster_name }}']

- name: Login to the OpenShift cluster
  include_role:
    name: openshift-login
  vars:
    _p_openshift_cluster_name: "{{ _current_cp4d_cluster.openshift_cluster_name }}"

- set_fact:
    _cp4d_admin_password_vault_key_name: "cp4d_admin_{{ _current_cp4d_cluster.project | replace('-','_') }}_{{ _current_cp4d_cluster.openshift_cluster_name | replace('-','_') }}"

- name: Retrieve CP4D admin password from vault secret {{ _cp4d_admin_password_vault_key_name }}
  include_role: 
    name: vault-get-secret
  vars:
    secret_name: "{{ _cp4d_admin_password_vault_key_name }}"
    secret_group: "{{ environment_name }}"
    _p_secret_variable: _cp4d_admin_password_vault

- name: Login to Cloud Pak for Data as the admin user
  include_role:
    name: cp4d-login
  vars:
    _p_cp4d_project: "{{ _current_cp4d_cluster.project }}"
    _p_cp4d_password: "{{ _cp4d_admin_password_vault }}"

- name: Generate cpd-cli config script
  include_role:
    name: cp4d-cpd-cli-config

- name: Run cpd-cli config script {{ config_dir }}/cp4d/{{ _current_cp4d_cluster.project }}-{{ _cp4d_user }}.sh
  shell: |
    {{ config_dir }}/cp4d/cpd-cli-{{ _current_cp4d_cluster.project }}-{{ _cp4d_user }}.sh

- stat:
    path: "{{ config_dir }}/{{_current_cp4d_asset.asset_location }}/cp4d-asset.sh"
  register: _cp4d_asset_shell

- name: Show cp4d-asset.sh file stats
  debug:
    var: _cp4d_asset_shell

- include_tasks: run-cp4d-asset-bash.yml
  when: _cp4d_asset_shell.stat.exists

- stat:
    path: "{{ config_dir }}/{{ _current_cp4d_asset.asset_location }}/cp4d-asset.yaml"
  register: _cp4d_asset_task

- name: Show cp4d-asset.yaml file stats
  debug:
    var: _cp4d_asset_task

- include_tasks: run-cp4d-asset-task.yml
  when: _cp4d_asset_task.stat.exists
